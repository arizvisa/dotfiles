#!/bin/sh
dashless=$(basename "$0" | sed -e 's/-/ /')

USAGE=
OPTIONS_STUCKLONG=1
OPTIONS_KEEPDASHDASH=1
OPTIONS_SPEC="${dashless} [<options>] -- <url> [<refspec> [<dir>]]

Display all of the available references for the given url.
  <url>       the location of the remote to query or clone

If the following parameters are given, the reference will be shallow cloned.
  <refspec>   the reference to clone from
  <dir>       the directory to clone into
--
h,help              show the help
q,quiet             only print error messages
v,verbose           run verbosely
d,depth=level       use this depth when performing the clone
since=date          include history since the given date
exclude=revision    exclude commits reachable from the given revision
"

NONGIT_OK=1
DEFAULT_PARAMETERS="--filter=blob:none --single-branch"

. git-sh-setup

parameters=( ${DEFAULT_PARAMETERS} )
while test $# -ne 0; do
    case "$1" in
    --quiet)
        GIT_QUIET=1
        ;;
    --depth=*)
        IFS== read _ arg <<< "$1"
        parameters=( ${parameters[@]} "--depth=${arg}" )
        ;;
    --help)
        usage
        ;;
    --since=*)
        IFS== read _ arg <<< "$1"
        parameters=( ${parameters[@]} "--shallow-since=${arg}" )
        ;;
    --exclude=*)
        IFS== read _ arg <<< "$1"
        parameters=( ${parameters[@]} "--shallow-exclude=${arg}" )
        ;;
    --verbose)
        parameters=( ${parameters[@]} "--verbose" )
        ;;
    --)
        shift
        break
        ;;
    -*)
        parameters=( ${parameters[@]} $1 )
        ;;
    *)
        usage
        ;;
    esac
    shift
done

set -- "$@"
if [ "$#" -eq 0 ]; then
    usage
elif [ "$#" -eq 1 ]; then
    url="$1"
    git ls-remote --tags --heads --refs --sort version:refname "${url}"
elif [ "$#" -le 3 ]; then
    url="$1"
    ref="$2"
    shift 2

    if [ "$#" -gt 0 ]; then
        directory="$1"
    else
        directory=`basename "${url}" .git`
    fi
    git clone "${parameters[@]}" --branch="${ref}" -- "${url}" "${directory}" && {
        name=`basename "${ref}"`
        current=`git -C "${directory}" branch --show-current`
        [ -z "${current}" ] && git -C "${directory}" checkout -b "${name}"
    }

else
    die_with_status 1 "${dashless}: unexpected number of parameters ($#). expected 1 to 3"
fi
