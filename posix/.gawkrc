# join.awk --- join an array into a string
function join(array, start, end, sep, result, i)
{
    increment = (start <= end)? +1 : -1
    if (sep == SUBSEP) # magic value
        sep = ""
    else if (start != end)
        result = array[start]
    else
        result = ""
    for (i = start + increment; i != end; i += increment)
        result = result sep array[i]
    return result
}

function max(a, b) {
    return (a < b)? b : a
}

function min(a, b) {
    return (a < b)? a : b
}

function keys(array, result,        base, key)
{
    base = 0;
    for (key in array)
        result[base++] = key
    return base
}

function split0(string, array, fieldsep, seps,      count, parts, result)
{
    result = split(string, parts, fieldsep, separators)
    count = 0
    for (key in parts)
        array[count++] = parts[key]
    count = 0
    for (key in separators)
        seps[count++] = separators[key]
    return result
}

function append(left, right, result)
{
    count = 0
    for (key in left)
        result[count++] = left[key]
    for (key in right)
        result[count++] = right[key]
    return count
}

function getslice(array, start, end, result,        half, count, i, base)
{
    half = length(array)
    count = append(array, array, doublearray)

    if ((start < 0) && (end < 0)) {
        start = half + start
        end = half + end
    } else if ((start >= 0) && (end >= 0)) {
        start = start
        end = end
    } else {
        start = (start < 0)? half + start : start
        end = (istart < half)? half + end : end
    }

    start = (start >= count)? count : max(0, start)
    end = (start < half)? min(end, start + half) : min(end, count)

    base = 0
    for (i = start; i < end; i++)
        result[base++] = doublearray[i]
    return base
}

function slice(string, sep, start, stop,            parts, sliced)
{
    split0(string, parts, sep)
    getslice(parts, start, stop, sliced)
    return join(sliced, 0, length(sliced), sep)
}

# fields.awk --- select a range of fields (skipping over field 0)
function fields(result, start, stop, step,       idx, count, left, right)
{
    stop = ((!stop) || (stop == SUBSEP))? NF : stop
    if ((step == SUBSEP) || !step) {
        step = (start <= stop)? +1 : -1
    }
    left = min(max(0, min(start, NF)), stop)
    right = max(max(0, min(stop, NF)), left)

    count = 0
    for (idx = left; left <= idx && idx < right; idx += step) {
        #result[count++] = $(idx)   # in case we want to include $1
        result[count++] = $(1 + idx)
    }
    return length(result)
}

# joinfields.awk --- join a range of the input fields by sep
function joinfields(sep, start, stop, step,      array, string, idx)
{
    sep = (sep == SUBSEP)? OFS : sep
    stop = (!stop || stop == SUBSEP)? NF : stop
    fields(array, start, stop, step)

    if (sep == SUBSEP) # magic value
        sep = ""

    string = length(array)? array[0] : ""
    for (idx = 1; idx < length(array); idx++)
        string = string sep array[idx]
    return string
}
